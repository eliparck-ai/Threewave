<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Juego de Retos Trio</title>
<style>
  :root { --bg:#0b0c10; --card:#111318; --ink:#f3f5f7; --muted:#a9b2be; --accent:#7c4dff; }
  * { box-sizing:border-box }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial; background:var(--bg); color:var(--ink) }
  header { position:sticky; top:0; background:linear-gradient(180deg, rgba(11,12,16,.95), rgba(11,12,16,.75)); backdrop-filter:blur(6px); padding:12px 16px; border-bottom:1px solid #1d2026; display:flex; gap:8px; flex-wrap:wrap }
  .chip { padding:6px 10px; border-radius:999px; background:#1b1f26; border:1px solid #272b33; color:var(--muted); font-size:12px }
  .lvl { font-weight:700 }
  .wrap { max-width:980px; margin:0 auto; padding:16px }
  .card { background:#111318; border:1px solid #1d2026; border-radius:16px; padding:16px }
  h1 { font-size:18px; margin:0 }
  h2 { font-size:16px; margin:0 0 10px; color:var(--muted) }
  label { display:block; margin:10px 0 6px; color:var(--muted) }
  input, select, button { width:100%; padding:12px 14px; border-radius:12px; border:1px solid #282c34; background:#151820; color:var(--ink) }
  button { background:var(--accent); border-color:transparent; font-weight:700; cursor:pointer }
  button.secondary { background:#1d2230; border:1px solid #2e3444; font-weight:600 }
  .row { display:grid; grid-template-columns:1fr 1fr; gap:12px }
  .row3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px }
  .pill { border-radius:999px; padding:4px 10px; background:#1c2030; border:1px solid #2a3042; color:var(--muted); font-size:12px; display:inline-block; margin-right:6px }
  .challenge { margin-top:14px; padding:14px; background:#0f1117; border:1px dashed #2a3042; border-radius:12px }
  .gridPlayers { display:grid; grid-template-columns:repeat(2,1fr); gap:8px }
  .gridPlayers .card { padding:12px }
  .footer { color:var(--muted); font-size:12px; text-align:center; padding:14px }
  .toast { position:fixed; bottom:14px; left:50%; transform:translateX(-50%); background:#1d2230; border:1px solid #2e3444; color:#fff; padding:8px 12px; border-radius:10px; font-size:12px; display:none; z-index:10 }
</style>
</head>
<body>
  <header>
    <button id="decLvl" class="secondary" type="button">◀︎</button>
    <div class="chip">Nivel: <span id="lvl" class="lvl">BAJO</span></div>
    <button id="incLvl" class="secondary" type="button">▶︎</button>
    <div class="chip">Ronda: <span id="round">0</span>/30</div>
    <div class="chip">Fase: <span id="phase">1/3</span></div>
  </header>

  <div class="wrap">
    <div class="card" id="setup">
      <h1>Configurar partida</h1>
      <label>Número de jugadores</label>
      <select id="numPlayers">
        <option>2</option><option selected>3</option><option>4</option><option>5</option><option>6</option>
      </select>

      <div id="playersCfg" class="gridPlayers" style="margin-top:12px;"></div>

      <div class="row" style="margin-top:12px;">
        <button id="start" type="button">Iniciar (Nivel BAJO)</button>
        <button id="shuffle" class="secondary" type="button">Aleatorizar Nombres</button>
      </div>
      <p style="color:#a9b2be; margin-top:10px">Tip: define <b>Género</b> y <b>Orientación</b> de cada jugador para que los retos se asignen correctamente.</p>
    </div>

    <div class="card" id="game" style="display:none;">
      <div class="row3">
        <div>
          <h2>Participantes</h2>
          <div id="playersList"></div>
        </div>
        <div>
          <h2>Control</h2>
          <div class="row">
            <button id="next" class="big" type="button">🎲 Sacar reto</button>
            <button id="skip" class="secondary" type="button">Saltar</button>
          </div>
          <div class="row" style="margin-top:10px;">
            <button id="reset" class="secondary" type="button">Reiniciar</button>
            <button id="backToSetup" class="secondary" type="button">Volver a Inicio</button>
          </div>
        </div>
        <div>
          <h2>Progreso</h2>
          <div class="pill">Nivel: <span id="lvl2">BAJO</span></div>
          <div class="pill">Ronda nivel: <span id="round2">0</span>/30</div>
          <div class="pill">Total retos: <span id="total">0</span></div>
        </div>
      </div>

      <div class="challenge" id="challengeBox" style="display:none;">
        <div style="color:#a9b2be">Título</div>
        <div id="chTitle" class="title"></div>
        <div style="color:#a9b2be; margin-top:8px">Reto</div>
        <div id="chText" class="big"></div>
        <div id="chNote" style="color:#a9b2be; margin-top:8px"></div>
      </div>
    </div>
    <div class="footer">Juego de Retos • v1.3</div>
  </div>

  <div id="toast" class="toast"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const toast = (msg) => {
    const el = document.getElementById('toast');
    el.innerText = msg; el.style.display='block';
    setTimeout(()=>{ el.style.display='none'; }, 1200);
  };

  // ===== RETOS POR DEFECTO (ejemplos; puedes ampliar la lista) =====
  let RETOS = [
    { titulo:"Beso rápido", reto:"{{ACTOR}} da un beso en la boca a {{ALGUIEN}} por 3 seg.", nota:"", nivel:"BAJO" },
    { titulo:"Caricia atrevida", reto:"{{ACTOR}} acaricia (sobre la ropa) la nalga de {{ALGUIEN}}.", nota:"", nivel:"BAJO" },
    { titulo:"Oral breve", reto:"{{ACTOR}} da sexo oral por 20 seg a {{ALGUIEN}}.", nota:"", nivel:"MEDIO" },
    { titulo:"Quitar prenda", reto:"{{ACTOR}} quita una prenda a {{ALGUIEN}}.", nota:"", nivel:"MEDIO" },
    { titulo:"Perrito", reto:"{{ACTOR}} adopta posición de perrito con {{ALGUIEN}}.", nota:"", nivel:"ALTO" },
    { titulo:"Doble contacto", reto:"{{ACTOR}} usa manos con {{ALGUIEN}} durante 20 seg.", nota:"", nivel:"ALTO" }
  ];

  const LEVELS = ["BAJO","MEDIO","ALTO"];
  const $ = (id) => document.getElementById(id);

  let state = {
    levelIndex:0, roundInLevel:0, totalRounds:0,
    players:[], // {name, gender:'M'|'F', orient:'hetero'|'homo'|'bi'}
    usedByLevel:{BAJO:[],MEDIO:[],ALTO:[]}
  };

  const currentLevel = () => LEVELS[state.levelIndex];

  function setLevel(idx){
    state.levelIndex = Math.max(0, Math.min(2, idx));
    $("lvl").textContent = currentLevel();
    $("lvl2").textContent = currentLevel();
    $("phase").textContent = (state.levelIndex+1)+"/3";
  }
  function nextRoundCounters(){
    state.roundInLevel++; state.totalRounds++;
    $("round").textContent = state.roundInLevel;
    $("round2").textContent = state.roundInLevel;
    $("total").textContent = state.totalRounds;
    if(state.roundInLevel>=30 && state.levelIndex<2){
      state.roundInLevel=0; setLevel(state.levelIndex+1); toast("⤴️ Cambio de nivel");
    }
  }
  function resetGame(){
    state.roundInLevel=0; state.totalRounds=0;
    state.usedByLevel={BAJO:[],MEDIO:[],ALTO:[]};
    setLevel(0); $("round").textContent=0; $("round2").textContent=0; $("total").textContent=0;
    $("challengeBox").style.display="none";
  }

  // === UI de jugadores ===
  function renderPlayersConfigurator(){
    const n = parseInt($("numPlayers").value,10);
    const root = $("playersCfg"); root.innerHTML="";
    const defaults = ["Ella","Pareja","Bull","Amiga","Amigo","Invitado"];
    for(let i=0;i<n;i++){
      const c = document.createElement("div"); c.className="card";
      c.innerHTML = `
        <label>Jugador ${i+1}</label>
        <input type="text" id="pname_${i}" value="${defaults[i%defaults.length]}">
        <label>Género</label>
        <select id="pg_${i}">
          <option value="M">Hombre</option>
          <option value="F" ${i===0?"selected":""}>Mujer</option>
        </select>
        <label>Orientación</label>
        <select id="po_${i}">
          <option value="hetero">Hetero</option>
          <option value="homo">Homosexual</option>
          <option value="bi">Bisexual</option>
        </select>
      `;
      root.appendChild(c);
    }
  }

  function collectPlayers(){
    const n = parseInt($("numPlayers").value,10);
    state.players = [];
    for(let i=0;i<n;i++){
      const name = $("pname_"+i).value.trim() || ("J"+(i+1));
      const gender = $("pg_"+i).value;
      const orient = $("po_"+i).value;
      state.players.push({ name, gender, orient });
    }
  }

  function listPlayers(){
    const root=$("playersList"); root.innerHTML="";
    const ul=document.createElement("ul"); ul.style.margin="0"; ul.style.paddingLeft="18px";
    const gtxt = g => g==="M"?"Hombre":"Mujer";
    const otxt = o => o==="hetero"?"Hetero":o==="homo"?"Homosexual":"Bisexual";
    state.players.forEach(p=>{
      const li=document.createElement("li");
      li.textContent=`${p.name} • ${gtxt(p.gender)} • ${otxt(p.orient)}`;
      ul.appendChild(li);
    });
    root.appendChild(ul);
  }

  // === Regla de compatibilidad según género + orientación del ACTOR ===
  function pickPartnerForActor(actor){
    let targetGenders;
    if (actor.orient === "hetero") {
      targetGenders = actor.gender === "M" ? ["F"] : ["M"];
    } else if (actor.orient === "homo") {
      targetGenders = actor.gender === "M" ? ["M"] : ["F"];
    } else { // bi
      targetGenders = ["M","F"];
    }
    let pool = state.players.filter(p => targetGenders.includes(p.gender) && p.name !== actor.name);
    if (pool.length === 0) pool = state.players.filter(p => p.name !== actor.name); // fallback
    return pool[(Math.random()*pool.length)|0];
  }

  function interpolateNames(text, actor){
    return text
      .replace(/{{ACTOR}}/g, actor.name)
      .replace(/{{ALGUIEN}}/g, pickPartnerForActor(actor).name);
  }

  function nextChallenge(){
    const lvl=currentLevel();
    const all=RETOS.map((r,idx)=>Object.assign({idx},r));
    let pool=all.filter(r=>r.nivel===lvl && !state.usedByLevel[lvl].includes(r.idx));
    if(pool.length===0){ state.usedByLevel[lvl]=[]; pool=all.filter(r=>r.nivel===lvl); }
    const pick=pool[(Math.random()*pool.length)|0];
    state.usedByLevel[lvl].push(pick.idx);

    // Elegimos actor al azar
    const actor = state.players[(Math.random()*state.players.length)|0];

    $("chTitle").textContent = pick.titulo || "Reto";
    $("chText").textContent  = interpolateNames(pick.reto || "", actor);
    $("chNote").textContent  = pick.nota ? ("Nota: "+pick.nota) : "";
    $("challengeBox").style.display="block";
    nextRoundCounters();
  }

  // === Bindings
  $("numPlayers").addEventListener("change",renderPlayersConfigurator);
  $("shuffle").addEventListener("click",()=>toast("🔀 Nombres aleatorizados"));
  $("start").addEventListener("click",()=>{
    collectPlayers(); if(state.players.length<2){toast("Mínimo 2 jugadores");return;}
    $("setup").style.display="none"; $("game").style.display="block";
    listPlayers(); resetGame(); toast("✅ ¡Partida iniciada!");
  });
  $("next").addEventListener("click",nextChallenge);
  $("skip").addEventListener("click",nextChallenge);
  $("reset").addEventListener("click",()=>{resetGame();toast("🔄 Reiniciado")});
  $("backToSetup").addEventListener("click",()=>{$("game").style.display="none";$("setup").style.display="block";toast("↩️ Inicio")});
  $("incLvl").addEventListener("click",()=>setLevel(state.levelIndex+1));
  $("decLvl").addEventListener("click",()=>setLevel(state.levelIndex-1));

  // init
  renderPlayersConfigurator(); setLevel(0);
});
</script>
</body>
</html>
