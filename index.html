<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Juego de Retos ‚Ä¢ Trio (v2.4 UI)</title>
<style>
  :root {
    --bg:#0b0c10; --card:#111318; --ink:#f3f5f7; --muted:#a9b2be; --accent:#7c4dff; --accent-2:#9c8cff;
    --border:#1d2026; --chip:#1b1f26; --chip2:#232838; --good:#22c55e; --warn:#f59e0b; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;background:linear-gradient(180deg,rgba(11,12,16,.95),rgba(11,12,16,.75));backdrop-filter:blur(6px);padding:12px 16px;border-bottom:1px solid var(--border)}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  h1{margin:0 0 8px 0;font-size:20px}
  h2{margin:0 0 10px 0;font-size:16px;color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
  .chip{padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid #272b33;color:var(--muted);font-size:12px}
  .seg{display:flex;gap:6px}
  .seg button{flex:1;padding:10px;border-radius:999px;border:1px solid var(--border);background:#171a23;color:#cfd6df;cursor:pointer}
  .seg button.active{background:linear-gradient(135deg,var(--accent),var(--accent-2));border-color:transparent;color:#fff;font-weight:700}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  label{display:block;margin:10px 0 6px;color:var(--muted)}
  input,select,button,textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #282c34;background:#151820;color:var(--ink)}
  button{cursor:pointer}
  button.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));border-color:transparent;color:#fff;font-weight:800}
  button.secondary{background:#1d2230;border:1px solid #2e3444;font-weight:600}
  textarea{min-height:120px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;resize:vertical}
  details summary{cursor:pointer;color:#d3d8e0;margin:8px 0}
  .progress{height:10px;background:#171a23;border-radius:999px;border:1px solid var(--border);overflow:hidden}
  .progress > div{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .25s ease}
  .gridPlayers{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .gridPlayers .card{padding:12px}
  .challenge{margin-top:14px;padding:16px;background:#0f1117;border:1px dashed #2a3042;border-radius:12px}
  .challenge .title{font-weight:800;margin-bottom:6px}
  .pill{border-radius:999px;padding:4px 10px;background:#1c2030;border:1px solid #2a3042;color:#a9b2be;font-size:12px;display:inline-block;margin-right:6px}
  .muted{color:#a9b2be;font-size:12px}
  .toast{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);background:#1d2230;border:1px solid #2e3444;color:#fff;padding:8px 12px;border-radius:10px;font-size:12px;display:none;z-index:20}
  /* Control inferior fijo */
  .dock{position:sticky;bottom:-1px;z-index:15;background:linear-gradient(180deg,rgba(11,12,16,.2),rgba(11,12,16,.9));backdrop-filter:blur(6px);border-top:1px solid var(--border);padding:10px 0;margin-top:14px}
  .dock .btns{display:grid;grid-template-columns:1.3fr 1fr 1fr 1fr;gap:8px}
  .btn-big{padding:16px 14px;border-radius:14px;font-size:16px}
  .btn-green{background:linear-gradient(135deg,#34d399,#22c55e);border-color:transparent;color:#05130a;font-weight:900}
  .btn-warn{background:#2a2530;border:1px solid #45324b}
  .btn-undo{background:#1c2838;border:1px solid #2e3f58}
  .history{margin-top:10px}
  .history ul{margin:0;padding-left:18px;max-height:150px;overflow:auto}
  .switch{display:flex;align-items:center;gap:8px}
  .footer{text-align:center;color:#a9b2be;font-size:12px;padding:14px}
</style>
</head>
<body>
  <header>
    <div class="wrap" style="padding:0 8px;">
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between">
        <div class="seg" style="flex:1;min-width:260px">
          <button id="btnLow"  class="active" type="button">BAJO</button>
          <button id="btnMid"  type="button">MEDIO</button>
          <button id="btnHigh" type="button">ALTO</button>
        </div>
        <div class="chip">Ronda: <span id="round">0</span>/30</div>
        <div class="chip">Fase: <span id="phase">1/3</span></div>
      </div>
      <div class="progress" style="margin-top:8px"><div id="bar"></div></div>
    </div>
  </header>

  <div class="wrap">
    <div class="card" id="setup">
      <h1>Configurar partida</h1>
      <label>N√∫mero de jugadores</label>
      <select id="numPlayers">
        <option>2</option><option selected>3</option><option>4</option><option>5</option><option>6</option>
      </select>

      <div id="playersCfg" class="gridPlayers" style="margin-top:12px;"></div>

      <details>
        <summary>Listas personalizadas (30 por nivel) ‚Ä¢ Guardado local</summary>
        <p class="muted">Un reto por l√≠nea. Puedes usar <code>{{ACTOR}}</code> y <code>{{ALGUIEN}}</code>. Nada se sube: todo queda en tu dispositivo.</p>
        <label>BAJO (30 l√≠neas)</label><textarea id="taLow"></textarea>
        <label>MEDIO (30 l√≠neas)</label><textarea id="taMid"></textarea>
        <label>ALTO (30 l√≠neas)</label><textarea id="taHigh" placeholder="Aqu√≠ puedes pegar tus textos intensos si lo deseas."></textarea>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
          <button id="useCustom" class="secondary" type="button">Usar listas pegadas</button>
          <button id="saveLS" class="secondary" type="button">Guardar en este dispositivo</button>
          <button id="exportBtn" class="secondary" type="button">Exportar (.json)</button>
          <label class="secondary" style="display:inline-block;padding:10px 14px;border-radius:12px;cursor:pointer">
            Importar (.json) <input id="importFile" type="file" accept=".json" style="display:none">
          </label>
          <button id="clearCustom" class="secondary" type="button">Volver a listas por defecto</button>
        </div>
      </details>

      <div class="row" style="margin-top:12px;">
        <button id="start" class="primary" type="button">Iniciar</button>
        <div class="switch">
          <input type="checkbox" id="vibe" />
          <label for="vibe">Vibrar al sacar reto</label>
        </div>
      </div>
      <p class="muted" style="margin-top:10px">
        Reglas: Hetero ‚Üí sexo opuesto. Homosexual ‚Üí mismo sexo y homo; si no hay, act√∫a como hetero. Bisexual ‚Üí cualquiera.
      </p>
    </div>

    <div class="card" id="game" style="display:none;">
      <div class="row3">
        <div>
          <h2>Participantes</h2>
          <div id="playersList"></div>
        </div>
        <div>
          <h2>Reto</h2>
          <div class="challenge" id="challengeBox" style="display:none;">
            <div class="title" id="chTitle"></div>
            <div id="chText"></div>
            <div id="chNote" class="muted" style="margin-top:6px"></div>
          </div>
        </div>
        <div>
          <h2>Estado</h2>
          <div class="pill">Nivel: <span id="lvl2">BAJO</span></div>
          <div class="pill">Ronda nivel: <span id="round2">0</span>/30</div>
          <div class="pill">Total retos: <span id="total">0</span></div>
        </div>
      </div>

      <div class="dock">
        <div class="btns wrap" style="padding-inline:16px">
          <button id="next" class="btn-big btn-green" type="button">üé≤ Sacar reto</button>
          <button id="skip" class="btn-big btn-warn" type="button">Saltar</button>
          <button id="undo" class="btn-big btn-undo" type="button">Deshacer</button>
          <button id="reset" class="btn-big secondary" type="button">Reiniciar</button>
        </div>
      </div>

      <details class="history">
        <summary>Historial (√∫ltimos 10)</summary>
        <ul id="histList"></ul>
      </details>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="backToSetup" class="secondary" type="button">Volver a Inicio</button>
        <button id="shuffle" class="secondary" type="button">Aleatorizar nombres</button>
      </div>
    </div>

    <div class="footer">Juego de Retos ‚Ä¢ v2.4 (UI mejorada, progreso, historial, deshacer)</div>
  </div>

  <div id="toast" class="toast"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const $ = id => document.getElementById(id);
  const toast = (msg) => { const el=$('toast'); el.innerText=msg; el.style.display='block'; setTimeout(()=>el.style.display='none',1200); };
  const vibrate = () => { if($('vibe').checked && navigator.vibrate) navigator.vibrate(20); };

  /* ===== RETOS DEFECTO (BAJO/MEDIO listos, ALTO editable por ti) ===== */
  const SAFE_DEFAULTS = {
    BAJO: [
      "{{ACTOR}} sopla suavemente en el cuello de {{ALGUIEN}} 5 seg.",
      "{{ACTOR}} respira en la nuca de {{ALGUIEN}} muy cerca 5 seg.",
      "{{ACTOR}} se coloca frente a frente con {{ALGUIEN}} y acerca su frente 3 seg.",
      "{{ACTOR}} acaricia las manos de {{ALGUIEN}} lentamente.",
      "{{ACTOR}} masajea los hombros de {{ALGUIEN}} 15 seg.",
      "{{ACTOR}} acaricia el antebrazo de {{ALGUIEN}} con la yema de los dedos.",
      "{{ACTOR}} roza la nariz con la de {{ALGUIEN}} (media luna) 2 seg.",
      "{{ACTOR}} posa su mano en la cintura de {{ALGUIEN}} 5 seg (sobre ropa).",
      "{{ACTOR}} besa la mejilla de {{ALGUIEN}} de forma corta.",
      "{{ACTOR}} besa la sien de {{ALGUIEN}}.",
      "{{ACTOR}} besa detr√°s de la oreja de {{ALGUIEN}} (breve).",
      "{{ACTOR}} acaricia la espalda baja de {{ALGUIEN}} sobre la ropa 5 seg.",
      "{{ACTOR}} desliza sus dedos por la mand√≠bula de {{ALGUIEN}}.",
      "{{ACTOR}} toma a {{ALGUIEN}} de la mano y da 3 pasos guiando.",
      "{{ACTOR}} apoya su frente en la de {{ALGUIEN}} y respiran juntos 5 seg.",
      "{{ACTOR}} se sienta muy pegado a {{ALGUIEN}} 10 seg.",
      "{{ACTOR}} baila lento con {{ALGUIEN}} 10 seg, marcando suavemente.",
      "{{ACTOR}} besa la frente de {{ALGUIEN}}.",
      "{{ACTOR}} roza la mejilla de {{ALGUIEN}} con sus pesta√±as (mariposa).",
      "{{ACTOR}} acaricia la rodilla de {{ALGUIEN}} (ropa) 3 seg.",
      "{{ACTOR}} roza los dedos por el cuello de {{ALGUIEN}} (sin labios).",
      "{{ACTOR}} besa la comisura de {{ALGUIEN}} sin tocar labios.",
      "{{ACTOR}} abraza a {{ALGUIEN}} lentamente 5 seg.",
      "{{ACTOR}} acomoda el cabello de {{ALGUIEN}} rozando su rostro.",
      "{{ACTOR}} acaricia la clav√≠cula de {{ALGUIEN}} sobre la ropa.",
      "{{ACTOR}} coloca su mano en el hombro de {{ALGUIEN}} 5 seg.",
      "{{ACTOR}} sopla aire tibio detr√°s de la oreja de {{ALGUIEN}}.",
      "{{ACTOR}} acerca su boca al cuello de {{ALGUIEN}} sin tocar 3 seg.",
      "{{ACTOR}} roza el muslo de {{ALGUIEN}} suavemente (ropa).",
      "{{ACTOR}} brinda con {{ALGUIEN}} y le dice qu√© le atrae de √©l/ella."
    ],
    MEDIO: [
      "{{ACTOR}} abre lentamente un bot√≥n o baja un cierre de {{ALGUIEN}}.",
      "{{ACTOR}} desliza la mano por la espalda de {{ALGUIEN}} bajo la ropa (zona alta).",
      "{{ACTOR}} besa la clav√≠cula de {{ALGUIEN}} con la prenda ligeramente apartada.",
      "{{ACTOR}} acaricia el abdomen de {{ALGUIEN}} bajo la ropa (breve).",
      "{{ACTOR}} besa lentamente el cuello de {{ALGUIEN}} 10 seg.",
      "{{ACTOR}} se sienta en el regazo de {{ALGUIEN}} 10 seg.",
      "{{ACTOR}} acaricia el muslo interno de {{ALGUIEN}} (ropa) 5 seg.",
      "{{ACTOR}} roza el costado del torso de {{ALGUIEN}} por dentro de la prenda (superficial).",
      "{{ACTOR}} besa el hombro descubierto de {{ALGUIEN}}.",
      "{{ACTOR}} gu√≠a a {{ALGUIEN}} del talle marcando ritmo 8 seg.",
      "{{ACTOR}} acerca su boca a la comisura de {{ALGUIEN}} sin besar 2 seg.",
      "{{ACTOR}} masajea la nuca de {{ALGUIEN}} 15 seg (con ambas manos).",
      "{{ACTOR}} acaricia la cadera de {{ALGUIEN}} con ambas manos 5 seg.",
      "{{ACTOR}} descubre un hombro de {{ALGUIEN}} y deja un beso.",
      "{{ACTOR}} desliza la mano desde el dorso hasta la cintura de {{ALGUIEN}}.",
      "{{ACTOR}} besa la base del cuello de {{ALGUIEN}} con pausa.",
      "{{ACTOR}} toma las manos de {{ALGUIEN}} y las apoya en su pecho (sobre ropa).",
      "{{ACTOR}} se sienta pegado a {{ALGUIEN}} y apoya su cabeza en su hombro.",
      "{{ACTOR}} susurra algo travieso (no gr√°fico) al o√≠do de {{ALGUIEN}}.",
      "{{ACTOR}} deja dos besos separados en el cuello de {{ALGUIEN}}.",
      "{{ACTOR}} acaricia la parte baja de la espalda de {{ALGUIEN}} bajo la ropa (breve).",
      "{{ACTOR}} gira a {{ALGUIEN}} tom√°ndolo de la cintura y lo acerca al pecho.",
      "{{ACTOR}} besa la l√≠nea de la mand√≠bula de {{ALGUIEN}} lentamente.",
      "{{ACTOR}} acaricia los gl√∫teos de {{ALGUIEN}} por encima de la ropa 5 seg.",
      "{{ACTOR}} roza el muslo de {{ALGUIEN}} subiendo un poco (ropa).",
      "{{ACTOR}} besa la espalda de {{ALGUIEN}} (zona alta).",
      "{{ACTOR}} roza con sus labios la oreja de {{ALGUIEN}} sin morder.",
      "{{ACTOR}} marca un balanceo de caderas con {{ALGUIEN}} 10 seg.",
      "{{ACTOR}} apoya su frente en la de {{ALGUIEN}} y lo besa en la mejilla.",
      "{{ACTOR}} gu√≠a las manos de {{ALGUIEN}} a su cintura por 5 seg."
    ],
    ALTO: [
      // Coloca aqu√≠ tus 30 retos expl√≠citos si lo deseas
      "[COMPLETAR] Reto 1",
      "[COMPLETAR] Reto 2",
      "[COMPLETAR] Reto 3",
      "[COMPLETAR] Reto 4",
      "[COMPLETAR] Reto 5",
      "[COMPLETAR] Reto 6",
      "[COMPLETAR] Reto 7",
      "[COMPLETAR] Reto 8",
      "[COMPLETAR] Reto 9",
      "[COMPLETAR] Reto 10",
      "[COMPLETAR] Reto 11",
      "[COMPLETAR] Reto 12",
      "[COMPLETAR] Reto 13",
      "[COMPLETAR] Reto 14",
      "[COMPLETAR] Reto 15",
      "[COMPLETAR] Reto 16",
      "[COMPLETAR] Reto 17",
      "[COMPLETAR] Reto 18",
      "[COMPLETAR] Reto 19",
      "[COMPLETAR] Reto 20",
      "[COMPLETAR] Reto 21",
      "[COMPLETAR] Reto 22",
      "[COMPLETAR] Reto 23",
      "[COMPLETAR] Reto 24",
      "[COMPLETAR] Reto 25",
      "[COMPLETAR] Reto 26",
      "[COMPLETAR] Reto 27",
      "[COMPLETAR] Reto 28",
      "[COMPLETAR] Reto 29",
      "[COMPLETAR] Reto 30"
    ]
  };

  const LEVELS = ["BAJO","MEDIO","ALTO"];
  let RETOS = JSON.parse(JSON.stringify(SAFE_DEFAULTS));

  let state = {
    levelIndex:0, roundInLevel:0, totalRounds:0,
    players:[], // {name, gender:'M'|'F', orient:'hetero'|'homo'|'bi'}
    usedByLevel:{BAJO:[],MEDIO:[],ALTO:[]},
    history:[], // {lvl, idx, actorName, text, counted}
  };

  const currentLevel = () => LEVELS[state.levelIndex];
  const gtxt = g => g==="M"?"Hombre":"Mujer";
  const otxt = o => o==="hetero"?"Hetero":o==="homo"?"Homosexual":"Bisexual";

  function syncUI(){
    $('lvl2').textContent = currentLevel();
    $('phase').textContent = (state.levelIndex+1)+"/3";
    $('round').textContent = state.roundInLevel;
    $('round2').textContent = state.roundInLevel;
    $('total').textContent = state.totalRounds;
    // progress bar
    $('bar').style.width = (Math.min(30, state.roundInLevel)/30*100)+'%';
    // segmented
    $('btnLow').classList.toggle('active', state.levelIndex===0);
    $('btnMid').classList.toggle('active', state.levelIndex===1);
    $('btnHigh').classList.toggle('active', state.levelIndex===2);
  }

  // ===== LocalStorage + import/export =====
  const LS_KEY = "retos_personalizados_v2";
  function saveToLS(){
    const data = { low:$('taLow').value||"", mid:$('taMid').value||"", high:$('taHigh').value||"" };
    try{ localStorage.setItem(LS_KEY, JSON.stringify(data)); toast("üíæ Guardado en el dispositivo"); }catch(e){}
  }
  function loadFromLS(){
    try{
      const raw = localStorage.getItem(LS_KEY); if(!raw) return;
      const d = JSON.parse(raw);
      if(d.low) $('taLow').value=d.low;
      if(d.mid) $('taMid').value=d.mid;
      if(d.high) $('taHigh').value=d.high;
    }catch(e){}
  }
  function exportJSON(){
    const data = {
      BAJO: $('taLow').value || SAFE_DEFAULTS.BAJO.join("\n"),
      MEDIO: $('taMid').value || SAFE_DEFAULTS.MEDIO.join("\n"),
      ALTO: $('taHigh').value || SAFE_DEFAULTS.ALTO.join("\n"),
    };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download='retos.json'; a.click(); URL.revokeObjectURL(url);
  }
  function importJSON(file){
    const r=new FileReader();
    r.onload=(ev)=>{
      try{
        const data=JSON.parse(ev.target.result);
        if(data.BAJO) $('taLow').value  = Array.isArray(data.BAJO)?data.BAJO.join("\n"):data.BAJO;
        if(data.MEDIO) $('taMid').value = Array.isArray(data.MEDIO)?data.MEDIO.join("\n"):data.MEDIO;
        if(data.ALTO) $('taHigh').value = Array.isArray(data.ALTO)?data.ALTO.join("\n"):data.ALTO;
        saveToLS(); toast("üì• Listas importadas");
      }catch{ toast("‚ö†Ô∏è Archivo inv√°lido"); }
    };
    r.readAsText(file);
  }

  // ===== Jugadores =====
  function renderPlayersConfigurator(){
    const n=parseInt($('numPlayers').value,10);
    const root=$('playersCfg'); root.innerHTML="";
    const defaults=["Ella","Pareja","Bull","Amiga","Amigo","Invitado"];
    for(let i=0;i<n;i++){
      const c=document.createElement('div'); c.className='card';
      c.innerHTML=`
        <label>Jugador ${i+1}</label>
        <input type="text" id="pname_${i}" value="${defaults[i%defaults.length]}">
        <label>G√©nero</label>
        <select id="pg_${i}"><option value="M">Hombre</option><option value="F" ${i===0?'selected':''}>Mujer</option></select>
        <label>Orientaci√≥n</label>
        <select id="po_${i}">
          <option value="hetero">Hetero</option>
          <option value="homo">Homosexual</option>
          <option value="bi">Bisexual</option>
        </select>`;
      root.appendChild(c);
    }
  }
  function collectPlayers(){
    const n=parseInt($('numPlayers').value,10);
    state.players=[]; for(let i=0;i<n;i++){
      const name=$('pname_'+i).value.trim()||('J'+(i+1));
      const gender=$('pg_'+i).value; const orient=$('po_'+i).value;
      state.players.push({name,gender,orient});
    }
  }
  function listPlayers(){
    const root=$('playersList'); root.innerHTML="";
    const ul=document.createElement('ul'); ul.style.margin='0'; ul.style.paddingLeft='18px';
    state.players.forEach(p=>{ const li=document.createElement('li'); li.textContent=`${p.name} ‚Ä¢ ${gtxt(p.gender)} ‚Ä¢ ${otxt(p.orient)}`; ul.appendChild(li); });
    root.appendChild(ul);
  }

  // ===== Emparejamiento =====
  function pickPartnerForActor(actor){
    let pool=[];
    if(actor.orient==='hetero'){
      const targets=actor.gender==='M'?['F']:['M'];
      pool=state.players.filter(p=>targets.includes(p.gender)&&p.name!==actor.name);
    }else if(actor.orient==='homo'){
      pool=state.players.filter(p=>p.gender===actor.gender&&p.orient==='homo'&&p.name!==actor.name);
      if(pool.length===0){
        const targets=actor.gender==='M'?['F']:['M'];
        pool=state.players.filter(p=>targets.includes(p.gender)&&p.name!==actor.name);
      }
    }else{ // bi
      pool=state.players.filter(p=>p.name!==actor.name);
    }
    if(pool.length===0) pool=state.players.filter(p=>p.name!==actor.name);
    return pool[(Math.random()*pool.length)|0];
  }
  const renderText=(t,a)=>t.replace(/{{ACTOR}}/g,a.name).replace(/{{ALGUIEN}}/g,pickPartnerForActor(a).name);

  // ===== Niveles & progreso =====
  function setLevel(idx,{manual=false}={}){
    const clamp=Math.max(0,Math.min(2,idx));
    if(clamp!==state.levelIndex){
      state.levelIndex=clamp; state.roundInLevel=0;
      $('challengeBox').style.display='none'; $('chTitle').textContent=''; $('chText').textContent=''; $('chNote').textContent='';
      if(manual) toast(`Nivel: ${currentLevel()}`);
    }
    syncUI();
  }
  function countRound(){
    state.roundInLevel++; state.totalRounds++;
    if(state.roundInLevel>=30 && state.levelIndex<2){
      state.roundInLevel=0; state.levelIndex++; toast("‚§¥Ô∏è Subes de nivel");
      $('challengeBox').style.display='none'; $('chTitle').textContent=''; $('chText').textContent=''; $('chNote').textContent='';
    }
    syncUI();
  }

  function pushHistory(entry){
    state.history.unshift(entry); // primero arriba
    if(state.history.length>30) state.history.pop();
    const ul=$('histList'); ul.innerHTML="";
    state.history.slice(0,10).forEach(h=>{
      const li=document.createElement('li');
      li.textContent=`[${h.lvl}] ${h.actorName} ‚Üí ${h.text}`;
      ul.appendChild(li);
    });
  }

  function drawChallenge({count=true}={}){
    const lvl=currentLevel();
    const all=(RETOS[lvl]||[]).map((t,idx)=>({idx,text:t}));
    if(!all.length){ toast("No hay retos en este nivel"); return; }

    let avail=all.filter(r=>!state.usedByLevel[lvl].includes(r.idx));
    if(avail.length===0){ state.usedByLevel[lvl]=[]; avail=all; }

    const pick=avail[(Math.random()*avail.length)|0];
    const actor=state.players[(Math.random()*state.players.length)|0];

    $('chTitle').textContent=`Nivel ${lvl}`;
    $('chText').textContent=renderText(pick.text||"",actor);
    $('chNote').textContent="";
    $('challengeBox').style.display='block';

    // historial
    pushHistory({lvl,idx:pick.idx,actorName:actor.name,text:$('chText').textContent,counted:!!count});

    if(count){
      state.usedByLevel[lvl].push(pick.idx);
      countRound();
    }
    vibrate();
  }

  function undoLast(){
    const last=state.history.find(h=>h.counted===true);
    if(!last){ toast("Nada para deshacer"); return; }
    // remover el primero contado del hist√≥rico (√©ste) para no deshacer dos veces
    const idx=state.history.indexOf(last);
    if(idx>-1) state.history.splice(idx,1);
    // revert counters y used
    if(state.roundInLevel===0 && state.levelIndex>0){
      state.levelIndex--; state.roundInLevel=29;
    }else{
      state.roundInLevel=Math.max(0,state.roundInLevel-1);
    }
    state.totalRounds=Math.max(0,state.totalRounds-1);
    const arr=state.usedByLevel[last.lvl]; const p=arr.indexOf(last.idx);
    if(p>-1) arr.splice(p,1);
    syncUI();
    toast("‚Ü©Ô∏è Deshecho");
  }

  function resetGame(){
    state.roundInLevel=0; state.totalRounds=0;
    state.usedByLevel={BAJO:[],MEDIO:[],ALTO:[]};
    state.history=[];
    $('histList').innerHTML="";
    $('challengeBox').style.display='none'; $('chTitle').textContent=''; $('chText').textContent=''; $('chNote').textContent='';
    syncUI();
  }

  // ===== Personalizaci√≥n =====
  function parseLines(id){ return ($(id).value||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean); }
  function applyCustomLists(){
    const low=parseLines('taLow'), mid=parseLines('taMid'), high=parseLines('taHigh');
    RETOS = { BAJO: low.length?low:SAFE_DEFAULTS.BAJO, MEDIO: mid.length?mid:SAFE_DEFAULTS.MEDIO, ALTO: high.length?high:SAFE_DEFAULTS.ALTO };
    state.usedByLevel={BAJO:[],MEDIO:[],ALTO:[]};
    $('challengeBox').style.display='none';
    saveToLS(); toast("‚úÖ Listas aplicadas");
  }
  function clearCustom(){
    $('taLow').value=$('taMid').value=$('taHigh').value="";
    RETOS=JSON.parse(JSON.stringify(SAFE_DEFAULTS));
    state.usedByLevel={BAJO:[],MEDIO:[],ALTO:[]};
    $('challengeBox').style.display='none';
    saveToLS(); toast("üîÑ Listas por defecto");
  }

  // ===== Eventos =====
  $('numPlayers').addEventListener('change',renderPlayersConfigurator);
  $('shuffle').addEventListener('click',()=>{
    const n=parseInt($('numPlayers').value,10);
    const pool=["Ella","Pareja","Bull","Amiga","Amigo","Invitado","X1","X2","X3"];
    for(let i=0;i<n;i++){ $('pname_'+i).value = pool[(Math.random()*pool.length)|0]; }
    toast("üîÄ Nombres aleatorizados");
  });

  $('useCustom').addEventListener('click',applyCustomLists);
  $('clearCustom').addEventListener('click',clearCustom);
  $('saveLS').addEventListener('click',saveToLS);
  $('exportBtn').addEventListener('click',exportJSON);
  $('importFile').addEventListener('change',e=>{ if(e.target.files[0]) importJSON(e.target.files[0]); });

  $('start').addEventListener('click',()=>{
    collectPlayers(); if(state.players.length<2){toast("M√≠nimo 2 jugadores");return;}
    $('setup').style.display='none'; $('game').style.display='block';
    listPlayers(); resetGame(); toast("‚úÖ ¬°Partida iniciada!");
  });

  $('next').addEventListener('click',()=>drawChallenge({count:true}));
  $('skip').addEventListener('click',()=>{ drawChallenge({count:false}); toast("‚è≠Ô∏è No cont√≥ la ronda"); });
  $('undo').addEventListener('click',undoLast);
  $('reset').addEventListener('click',()=>{ resetGame(); toast("üîÑ Reiniciado"); });
  $('backToSetup').addEventListener('click',()=>{ $('game').style.display='none'; $('setup').style.display='block'; syncUI(); toast("‚Ü©Ô∏è Inicio"); });

  // segmented level buttons
  $('btnLow').addEventListener('click',()=>setLevel(0,{manual:true}));
  $('btnMid').addEventListener('click',()=>setLevel(1,{manual:true}));
  $('btnHigh').addEventListener('click',()=>setLevel(2,{manual:true}));

  // init
  renderPlayersConfigurator();
  loadFromLS();
  syncUI();
});
</script>
</body>
</html>
