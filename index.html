<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Juego de Retos Trio ‚Ä¢ v1.7</title>
<style>
  :root { --bg:#0b0c10; --card:#111318; --ink:#f3f5f7; --muted:#a9b2be; --accent:#7c4dff; }
  * { box-sizing:border-box }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial; background:var(--bg); color:var(--ink) }
  header { position:sticky; top:0; background:linear-gradient(180deg, rgba(11,12,16,.95), rgba(11,12,16,.75)); backdrop-filter:blur(6px); padding:12px 16px; border-bottom:1px solid #1d2026; display:flex; gap:8px; flex-wrap:wrap }
  .chip { padding:6px 10px; border-radius:999px; background:#1b1f26; border:1px solid #272b33; color:var(--muted); font-size:12px }
  .lvl { font-weight:700 }
  .wrap { max-width:980px; margin:0 auto; padding:16px }
  .card { background:#111318; border:1px solid #1d2026; border-radius:16px; padding:16px }
  h1 { font-size:18px; margin:0 }
  h2 { font-size:16px; margin:0 0 10px; color:var(--muted) }
  label { display:block; margin:10px 0 6px; color:var(--muted) }
  input, select, button { width:100%; padding:12px 14px; border-radius:12px; border:1px solid #282c34; background:#151820; color:var(--ink) }
  button { background:var(--accent); border-color:transparent; font-weight:700; cursor:pointer }
  button.secondary { background:#1d2230; border:1px solid #2e3444; font-weight:600 }
  .row { display:grid; grid-template-columns:1fr 1fr; gap:12px }
  .row3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px }
  .pill { border-radius:999px; padding:4px 10px; background:#1c2030; border:1px solid #2a3042; color:#a9b2be; font-size:12px; display:inline-block; margin-right:6px }
  .challenge { margin-top:14px; padding:14px; background:#0f1117; border:1px dashed #2a3042; border-radius:12px }
  .gridPlayers { display:grid; grid-template-columns:repeat(2,1fr); gap:8px }
  .gridPlayers .card { padding:12px }
  .footer { color:#a9b2be; font-size:12px; text-align:center; padding:14px }
  .toast { position:fixed; bottom:14px; left:50%; transform:translateX(-50%); background:#1d2230; border:1px solid #2e3444; color:#fff; padding:8px 12px; border-radius:10px; font-size:12px; display:none; z-index:10 }
</style>
</head>
<body>
  <header>
    <button id="decLvl" class="secondary" type="button">‚óÄÔ∏é</button>
    <div class="chip">Nivel: <span id="lvl" class="lvl">BAJO</span></div>
    <button id="incLvl" class="secondary" type="button">‚ñ∂Ô∏é</button>
    <div class="chip">Ronda: <span id="round">0</span>/30</div>
    <div class="chip">Fase: <span id="phase">1/3</span></div>
  </header>

  <div class="wrap">
    <div class="card" id="setup">
      <h1>Configurar partida</h1>
      <label>N√∫mero de jugadores</label>
      <select id="numPlayers">
        <option>2</option><option selected>3</option><option>4</option><option>5</option><option>6</option>
      </select>

      <div id="playersCfg" class="gridPlayers" style="margin-top:12px;"></div>

      <div class="row" style="margin-top:12px;">
        <button id="start" type="button">Iniciar (Nivel BAJO)</button>
        <button id="shuffle" class="secondary" type="button">Aleatorizar Nombres</button>
      </div>
      <p style="color:#a9b2be; margin-top:10px">Define <b>G√©nero</b> (H/M) y <b>Orientaci√≥n</b> (Hetero / Homosexual / Bisexual). Reglas de compatibilidad activas.</p>
    </div>

    <div class="card" id="game" style="display:none;">
      <div class="row3">
        <div>
          <h2>Participantes</h2>
          <div id="playersList"></div>
        </div>
        <div>
          <h2>Control</h2>
          <div class="row">
            <button id="next" class="big" type="button">üé≤ Sacar reto</button>
            <button id="skip" class="secondary" type="button">Saltar</button>
          </div>
          <div class="row" style="margin-top:10px;">
            <button id="reset" class="secondary" type="button">Reiniciar</button>
            <button id="backToSetup" class="secondary" type="button">Volver a Inicio</button>
          </div>
        </div>
        <div>
          <h2>Progreso</h2>
          <div class="pill">Nivel: <span id="lvl2">BAJO</span></div>
          <div class="pill">Ronda nivel: <span id="round2">0</span>/30</div>
          <div class="pill">Total retos: <span id="total">0</span></div>
        </div>
      </div>

      <div class="challenge" id="challengeBox" style="display:none;">
        <div style="color:#a9b2be">T√≠tulo</div>
        <div id="chTitle" class="title"></div>
        <div style="color:#a9b2be; margin-top:8px">Reto</div>
        <div id="chText" class="big"></div>
        <div id="chNote" style="color:#a9b2be; margin-top:8px"></div>
      </div>
    </div>
    <div class="footer">Juego de Retos ‚Ä¢ v1.7</div>
  </div>

  <div id="toast" class="toast"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const toast = (msg) => {
    const el = document.getElementById('toast');
    el.innerText = msg; el.style.display='block';
    setTimeout(()=>{ el.style.display='none'; }, 1200);
  };

  /* ========== RETOS (30/30/30, no repetitivos, ya de v1.6) ========== */
  const RETOS = [
    /* --- BAJO (1‚Äì30) --- */
    { titulo:"Miradas c√≥mplices", reto:"{{ACTOR}} sostiene la mirada de {{ALGUIEN}} con una sonrisa 5 seg.", nivel:"BAJO" },
    { titulo:"Susurro suave", reto:"{{ACTOR}} susurra un cumplido al o√≠do de {{ALGUIEN}}.", nivel:"BAJO" },
    { titulo:"Mano en cintura", reto:"{{ACTOR}} posa su mano en la cintura de {{ALGUIEN}} 5 seg (ropa).", nivel:"BAJO" },
    { titulo:"Beso en mejilla", reto:"{{ACTOR}} da un beso en la mejilla de {{ALGUIEN}}.", nivel:"BAJO" },
    { titulo:"Abrazo lento", reto:"{{ACTOR}} abraza a {{ALGUIEN}} lentamente 5 seg.", nivel:"BAJO" },
    { titulo:"Olfato al cuello", reto:"{{ACTOR}} huele el cuello de {{ALGUIEN}} y le dice a qu√© le recuerda.", nivel:"BAJO" },
    { titulo:"Acomoda cabello", reto:"{{ACTOR}} acomoda el cabello de {{ALGUIEN}} con cuidado.", nivel:"BAJO" },
    { titulo:"Nariz con nariz", reto:"{{ACTOR}} roza su nariz con la de {{ALGUIEN}} 3 seg.", nivel:"BAJO" },
    { titulo:"Manos entrelazadas", reto:"{{ACTOR}} entrelaza sus dedos con los de {{ALGUIEN}} y hace un giro suave.", nivel:"BAJO" },
    { titulo:"Beso en frente", reto:"{{ACTOR}} besa la frente de {{ALGUIEN}}.", nivel:"BAJO" },
    { titulo:"Caricia de manos", reto:"{{ACTOR}} acaricia el dorso de la mano de {{ALGUIEN}} 5 seg.", nivel:"BAJO" },
    { titulo:"Toque de hombro", reto:"{{ACTOR}} posa su mano en el hombro de {{ALGUIEN}} 5 seg.", nivel:"BAJO" },
    { titulo:"Beso en sien", reto:"{{ACTOR}} da un beso suave en la sien de {{ALGUIEN}}.", nivel:"BAJO" },
    { titulo:"Rostro cerca", reto:"{{ACTOR}} acerca su frente a la de {{ALGUIEN}} 3 seg (sin besar).", nivel:"BAJO" },
    { titulo:"Mano en espalda", reto:"{{ACTOR}} posa la mano en la parte baja de la espalda de {{ALGUIEN}} 5 seg.", nivel:"BAJO" },
    { titulo:"Baile corto", reto:"{{ACTOR}} baila junto a {{ALGUIEN}} 10 seg, pegados pero suaves.", nivel:"BAJO" },
    { titulo:"Cosquillas ligeras", reto:"{{ACTOR}} hace cosquillas suaves a {{ALGUIEN}} 2 seg (con permiso).", nivel:"BAJO" },
    { titulo:"Gui√±o y secreto", reto:"{{ACTOR}} le gui√±a un ojo a {{ALGUIEN}} y le dice un secreto breve.", nivel:"BAJO" },
    { titulo:"Beso en mano", reto:"{{ACTOR}} besa la mano de {{ALGUIEN}} con calma.", nivel:"BAJO" },
    { titulo:"Cuello sombra", reto:"{{ACTOR}} acerca sus labios al cuello de {{ALGUIEN}} sin tocar 3 seg.", nivel:"BAJO" },
    { titulo:"Giro dulce", reto:"{{ACTOR}} toma a {{ALGUIEN}} de la cintura y lo/la gira lentamente.", nivel:"BAJO" },
    { titulo:"Hombro a hombro", reto:"{{ACTOR}} apoya su hombro con el de {{ALGUIEN}} 5 seg.", nivel:"BAJO" },
    { titulo:"Acariciar antebrazo", reto:"{{ACTOR}} recorre con un dedo el antebrazo de {{ALGUIEN}}.", nivel:"BAJO" },
    { titulo:"Beso detr√°s de oreja", reto:"{{ACTOR}} deja un beso detr√°s de la oreja de {{ALGUIEN}}.", nivel:"BAJO" },
    { titulo:"Respirar juntos", reto:"{{ACTOR}} y {{ALGUIEN}} respiran coordinados 5 seg muy cerca.", nivel:"BAJO" },
    { titulo:"Dibujar en piel", reto:"{{ACTOR}} dibuja una figura en la mano de {{ALGUIEN}} con el dedo.", nivel:"BAJO" },
    { titulo:"Beso en cuello breve", reto:"{{ACTOR}} da un beso muy corto en el cuello de {{ALGUIEN}}.", nivel:"BAJO" },
    { titulo:"Pesta√±as mariposa", reto:"{{ACTOR}} roza la mejilla de {{ALGUIEN}} con sus pesta√±as.", nivel:"BAJO" },
    { titulo:"Silla pegaditos", reto:"{{ACTOR}} se sienta junto a {{ALGUIEN}} muy pegado 5 seg.", nivel:"BAJO" },
    { titulo:"Brindis y halago", reto:"{{ACTOR}} brinda con {{ALGUIEN}} y le dice qu√© le atrae de √©l/ella.", nivel:"BAJO" },

    /* --- MEDIO (31‚Äì60) --- */
    { titulo:"Beso en cuello", reto:"{{ACTOR}} besa el cuello de {{ALGUIEN}} 5 seg.", nivel:"MEDIO" },
    { titulo:"L√≥bulo de oreja", reto:"{{ACTOR}} roza el l√≥bulo de la oreja de {{ALGUIEN}} con un beso suave.", nivel:"MEDIO" },
    { titulo:"Masaje de nuca", reto:"{{ACTOR}} da un mini masaje de nuca a {{ALGUIEN}} 15 seg.", nivel:"MEDIO" },
    { titulo:"Mano en muslo (ropa)", reto:"{{ACTOR}} posa la mano en el muslo de {{ALGUIEN}} 5 seg (ropa).", nivel:"MEDIO" },
    { titulo:"Abrazo por detr√°s", reto:"{{ACTOR}} abraza por la espalda a {{ALGUIEN}} 5 seg.", nivel:"MEDIO" },
    { titulo:"Baile pegado", reto:"{{ACTOR}} baila pegado con {{ALGUIEN}} 20 seg.", nivel:"MEDIO" },
    { titulo:"Ojos vendados", reto:"{{ACTOR}} venda suavemente los ojos de {{ALGUIEN}} y le susurra algo.", nivel:"MEDIO" },
    { titulo:"Gu√≠a de manos", reto:"{{ALGUIEN}} gu√≠a la mano de {{ACTOR}} por su espalda (ropa) 5 seg.", nivel:"MEDIO" },
    { titulo:"Abrir bot√≥n", reto:"{{ACTOR}} abre un bot√≥n superficial o baja un cierre 2 cm a {{ALGUIEN}}.", nivel:"MEDIO" },
    { titulo:"Regazo 10s", reto:"{{ACTOR}} se sienta en el regazo de {{ALGUIEN}} 10 seg.", nivel:"MEDIO" },
    { titulo:"Comisura cercana", reto:"{{ACTOR}} acerca su boca a la comisura de {{ALGUIEN}} sin besar 2 seg.", nivel:"MEDIO" },
    { titulo:"Masaje hombros", reto:"{{ACTOR}} masajea hombros de {{ALGUIEN}} 15 seg.", nivel:"MEDIO" },
    { titulo:"Rodear cintura", reto:"{{ACTOR}} rodea con ambos brazos la cintura de {{ALGUIEN}} 5 seg.", nivel:"MEDIO" },
    { titulo:"Costado torso", reto:"{{ACTOR}} pasa su mano por el costado del torso de {{ALGUIEN}} (ropa) lento.", nivel:"MEDIO" },
    { titulo:"Beso en hombro", reto:"{{ACTOR}} besa un hombro de {{ALGUIEN}}.", nivel:"MEDIO" },
    { titulo:"Confiesa fantas√≠a", reto:"{{ACTOR}} le cuenta a {{ALGUIEN}} una fantas√≠a breve.", nivel:"MEDIO" },
    { titulo:"Mano a cintura guiada", reto:"{{ALGUIEN}} coloca la mano de {{ACTOR}} en su cintura por 5 seg.", nivel:"MEDIO" },
    { titulo:"Giro al pecho", reto:"{{ACTOR}} toma las manos de {{ALGUIEN}} y lo acerca a su pecho (ropa).", nivel:"MEDIO" },
    { titulo:"Cadera (ropa)", reto:"{{ACTOR}} acaricia la cadera de {{ALGUIEN}} 5 seg (ropa).", nivel:"MEDIO" },
    { titulo:"Beso lento mejilla", reto:"{{ACTOR}} da un beso lento en la mejilla de {{ALGUIEN}} (2 seg).", nivel:"MEDIO" },
    { titulo:"Frente a frente", reto:"{{ACTOR}} apoya su frente en la de {{ALGUIEN}} y respiran juntos 5 seg.", nivel:"MEDIO" },
    { titulo:"Casi beso", reto:"{{ACTOR}} acerca sus labios a 1 cm de los de {{ALGUIEN}} 3 seg sin tocar.", nivel:"MEDIO" },
    { titulo:"Descubre hombro", reto:"{{ACTOR}} descubre un hombro de {{ALGUIEN}} y lo besa una vez.", nivel:"MEDIO" },
    { titulo:"Dorso a cintura", reto:"{{ACTOR}} desliza su mano desde el dorso hasta la cintura de {{ALGUIEN}}.", nivel:"MEDIO" },
    { titulo:"Dobles manos", reto:"{{ACTOR}} toma ambas manos de {{ALGUIEN}} y las lleva a su pecho (ropa) 5 seg.", nivel:"MEDIO" },
    { titulo:"Sill√≥n pegado", reto:"{{ACTOR}} se sienta pegado a {{ALGUIEN}} y apoya su cabeza en su hombro.", nivel:"MEDIO" },
    { titulo:"Eco al o√≠do", reto:"{{ACTOR}} repite al o√≠do de {{ALGUIEN}} lo que quiera o√≠r, muy cerca.", nivel:"MEDIO" },
    { titulo:"Doble cuello", reto:"{{ACTOR}} deja dos besos en el cuello de {{ALGUIEN}} con pausa.", nivel:"MEDIO" },
    { titulo:"Gu√≠a de caderas", reto:"{{ACTOR}} toma las caderas de {{ALGUIEN}} y marca un ritmo suave 10 seg.", nivel:"MEDIO" },
    { titulo:"Regazo invertido", reto:"{{ACTOR}} se sienta de espaldas a {{ALGUIEN}} entre sus piernas 10 seg.", nivel:"MEDIO" },

    /* --- ALTO (61‚Äì90) --- */
    { titulo:"Beso breve en labios", reto:"{{ACTOR}} da un beso breve en los labios de {{ALGUIEN}}.", nivel:"ALTO" },
    { titulo:"Sillita mirada fija", reto:"{{ACTOR}} se sienta en el regazo de {{ALGUIEN}} mir√°ndole a los ojos 10 seg.", nivel:"ALTO" },
    { titulo:"Cuello lento", reto:"{{ACTOR}} besa y recorre el cuello de {{ALGUIEN}} 7 seg.", nivel:"ALTO" },
    { titulo:"Mano guiada atrevida", reto:"{{ALGUIEN}} gu√≠a la mano de {{ACTOR}} por su costado hasta la cadera (ropa).", nivel:"ALTO" },
    { titulo:"Labio inferior", reto:"{{ACTOR}} muerde muy suave el labio inferior de {{ALGUIEN}}.", nivel:"ALTO" },
    { titulo:"Baile muy pegado", reto:"{{ACTOR}} baila con {{ALGUIEN}} de forma muy pegada 20 seg.", nivel:"ALTO" },
    { titulo:"Espalda descubierta", reto:"{{ACTOR}} descubre parte de la espalda de {{ALGUIEN}} y la recorre con besos.", nivel:"ALTO" },
    { titulo:"Sugerencia al o√≠do", reto:"{{ACTOR}} describe a {{ALGUIEN}} c√≥mo le gustar√≠a que lo/la besen luego.", nivel:"ALTO" },
    { titulo:"Rodilla entre piernas", reto:"{{ACTOR}} apoya una rodilla entre las piernas de {{ALGUIEN}} (ropa) 5 seg.", nivel:"ALTO" },
    { titulo:"Rostro entre manos", reto:"{{ACTOR}} sujeta el rostro de {{ALGUIEN}} con ambas manos y le da un beso corto.", nivel:"ALTO" },
    { titulo:"Sentadilla juntos", reto:"{{ACTOR}} y {{ALGUIEN}} bajan juntos muy cerca y suben coordinados.", nivel:"ALTO" },
    { titulo:"Beso prolongado", reto:"{{ACTOR}} da un beso prolongado a {{ALGUIEN}} (3‚Äì5 seg).", nivel:"ALTO" },
    { titulo:"Cintura a cintura", reto:"{{ACTOR}} rodea la cintura de {{ALGUIEN}} y lo acerca a su cuerpo 5 seg.", nivel:"ALTO" },
    { titulo:"Abrazo por cuello", reto:"{{ACTOR}} abraza a {{ALGUIEN}} por el cuello y besa su mejilla lentamente.", nivel:"ALTO" },
    { titulo:"Silla invertida", reto:"{{ACTOR}} se sienta de espaldas a {{ALGUIEN}} entre sus piernas 10 seg.", nivel:"ALTO" },
    { titulo:"Cuatro puntos", reto:"{{ACTOR}} besa frente, mejilla, otra mejilla y comisura de {{ALGUIEN}}.", nivel:"ALTO" },
    { titulo:"Nariz y comisura", reto:"{{ACTOR}} roza su nariz con la de {{ALGUIEN}} y besa su comisura.", nivel:"ALTO" },
    { titulo:"Caderas al ritmo", reto:"{{ACTOR}} sujeta caderas de {{ALGUIEN}} y marca un ritmo 10 seg.", nivel:"ALTO" },
    { titulo:"Pecho con pecho", reto:"{{ACTOR}} apoya su pecho con el de {{ALGUIEN}} y respiran juntos 5 seg.", nivel:"ALTO" },
    { titulo:"Beso-pausa-beso", reto:"{{ACTOR}} besa a {{ALGUIEN}}, hace una pausa y vuelve a besar.", nivel:"ALTO" },
    { titulo:"Beso sorpresa", reto:"{{ACTOR}} pide a {{ALGUIEN}} cerrar los ojos y da un beso suave.", nivel:"ALTO" },
    { titulo:"Muslo por fuera", reto:"{{ACTOR}} acaricia por fuera el muslo de {{ALGUIEN}} lentamente 5 seg.", nivel:"ALTO" },
    { titulo:"Giro a tres", reto:"{{ACTOR}} coloca a {{ALGUIEN}} cerca y hace un giro invitando al tercero.", nivel:"ALTO" },
    { titulo:"Beso alterno", reto:"{{ACTOR}} besa a {{ALGUIEN}} y mira al tercero con picard√≠a.", nivel:"ALTO" },
    { titulo:"Mariposa y beso", reto:"{{ACTOR}} roza con pesta√±as la mejilla de {{ALGUIEN}} y da un beso.", nivel:"ALTO" },
    { titulo:"Manos al pecho (ropa)", reto:"{{ACTOR}} toma una mano de {{ALGUIEN}} y la lleva a su pecho (ropa) 5 seg.", nivel:"ALTO" },
    { titulo:"Vuelta pegada", reto:"{{ACTOR}} toma de la cintura a {{ALGUIEN}} y lo hace girar muy pegado.", nivel:"ALTO" },
    { titulo:"Beso intenso", reto:"{{ACTOR}} da un beso intenso pero corto a {{ALGUIEN}}.", nivel:"ALTO" },
    { titulo:"Cierre dulce", reto:"{{ACTOR}} le dice a {{ALGUIEN}} qu√© imagen se lleva de este momento.", nivel:"ALTO" }
  ];

  const LEVELS = ["BAJO","MEDIO","ALTO"];
  const $ = (id) => document.getElementById(id);

  let state = {
    levelIndex:0, roundInLevel:0, totalRounds:0,
    players:[], // {name, gender:'M'|'F', orient:'hetero'|'homo'|'bi'}
    usedByLevel:{BAJO:[],MEDIO:[],ALTO:[]},
    inGame:false
  };

  const currentLevel = () => LEVELS[state.levelIndex];

  function syncUI() {
    $("lvl").textContent = currentLevel();
    $("lvl2").textContent = currentLevel();
    $("phase").textContent = (state.levelIndex+1)+"/3";
    $("round").textContent = state.roundInLevel;
    $("round2").textContent = state.roundInLevel;
    $("total").textContent = state.totalRounds;
    // Bot√≥n iniciar refleja nivel actual
    $("start").textContent = `Iniciar (Nivel ${currentLevel()})`;
  }

  function setLevel(idx, {manual=false} = {}){
    const clamped = Math.max(0, Math.min(2, idx));
    if (clamped !== state.levelIndex) {
      state.levelIndex = clamped;
      // Al cambiar de nivel manualmente, reiniciar contador del nivel
      state.roundInLevel = 0;
      // No tocamos totalRounds para mantener el hist√≥rico
      syncUI();
      if (manual) toast(`Nivel cambiado a ${currentLevel()}`);
    } else {
      // Si no cambi√≥, solo sincroniza por si acaso
      syncUI();
    }
  }

  function nextRoundCounters(){
    state.roundInLevel++; state.totalRounds++;
    if(state.roundInLevel>=30 && state.levelIndex<2){
      state.roundInLevel=0; state.levelIndex++; toast("‚§¥Ô∏è Cambio de nivel autom√°tico");
    }
    syncUI();
  }

  function resetGame(){
    state.roundInLevel=0; state.totalRounds=0; state.inGame=false;
    state.usedByLevel={BAJO:[],MEDIO:[],ALTO:[]};
    setLevel(0); $("challengeBox").style.display="none";
  }

  // === UI de jugadores (con ORIENTACI√ìN) ===
  function renderPlayersConfigurator(){
    const n = parseInt($("numPlayers").value,10);
    const root = $("playersCfg"); root.innerHTML="";
    const defaults = ["Ella","Pareja","Bull","Amiga","Amigo","Invitado"];
    for(let i=0;i<n;i++){
      const c = document.createElement("div"); c.className="card";
      c.innerHTML = `
        <label>Jugador ${i+1}</label>
        <input type="text" id="pname_${i}" value="${defaults[i%defaults.length]}">
        <label>G√©nero</label>
        <select id="pg_${i}">
          <option value="M">Hombre</option>
          <option value="F" ${i===0?"selected":""}>Mujer</option>
        </select>
        <label>Orientaci√≥n</label>
        <select id="po_${i}">
          <option value="hetero">Hetero</option>
          <option value="homo">Homosexual</option>
          <option value="bi">Bisexual</option>
        </select>
      `;
      root.appendChild(c);
    }
  }

  function collectPlayers(){
    const n = parseInt($("numPlayers").value,10);
    state.players = [];
    for(let i=0;i<n;i++){
      const name = $("pname_"+i).value.trim() || ("J"+(i+1));
      const gender = $("pg_"+i).value;
      const orient = $("po_"+i).value;
      state.players.push({ name, gender, orient });
    }
  }

  function listPlayers(){
    const root=$("playersList"); root.innerHTML="";
    const ul=document.createElement("ul"); ul.style.margin="0"; ul.style.paddingLeft="18px";
    const gtxt = g => g==="M"?"Hombre":"Mujer";
    const otxt = o => o==="hetero"?"Hetero":o==="homo"?"Homosexual":"Bisexual";
    state.players.forEach(p=>{
      const li=document.createElement("li");
      li.textContent=`${p.name} ‚Ä¢ ${gtxt(p.gender)} ‚Ä¢ ${otxt(p.orient)}`;
      ul.appendChild(li);
    });
    root.appendChild(ul);
  }

  // === Compatibilidad g√©nero + orientaci√≥n del ACTOR ===
  // Homo: si no hay otro homo del mismo sexo ‚Üí act√∫a como hetero.
  function pickPartnerForActor(actor){
    let pool = [];

    if (actor.orient === "hetero") {
      const targetGenders = actor.gender === "M" ? ["F"] : ["M"];
      pool = state.players.filter(p => targetGenders.includes(p.gender) && p.name !== actor.name);

    } else if (actor.orient === "homo") {
      pool = state.players.filter(
        p => p.gender === actor.gender && p.orient === "homo" && p.name !== actor.name
      );
      if (pool.length === 0) {
        const targetGenders = actor.gender === "M" ? ["F"] : ["M"];
        pool = state.players.filter(p => targetGenders.includes(p.gender) && p.name !== actor.name);
      }

    } else { // bi
      pool = state.players.filter(p => p.name !== actor.name);
    }

    if (pool.length === 0) pool = state.players.filter(p => p.name !== actor.name);
    return pool[(Math.random()*pool.length)|0];
  }

  function interpolateNames(text, actor){
    return text
      .replace(/{{ACTOR}}/g, actor.name)
      .replace(/{{ALGUIEN}}/g, pickPartnerForActor(actor).name);
  }

  function nextChallenge(){
    const lvl = currentLevel(); // nivel ACTUAL
    const all = RETOS.map((r,idx)=>({ ...r, idx, nivel:(r.nivel||"").toString().trim().toUpperCase() }));
    let pool = all.filter(r => r.nivel === lvl && !state.usedByLevel[lvl].includes(r.idx));
    if(pool.length === 0){ state.usedByLevel[lvl] = []; pool = all.filter(r => r.nivel === lvl); }

    const pick = pool[(Math.random()*pool.length)|0];
    state.usedByLevel[lvl].push(pick.idx);

    const actor = state.players[(Math.random()*state.players.length)|0];

    $("chTitle").textContent = pick.titulo || "Reto";
    $("chText").textContent  = interpolateNames(pick.reto || "", actor);
    $("chNote").textContent  = pick.nota ? ("Nota: "+pick.nota) : "";
    $("challengeBox").style.display="block";

    nextRoundCounters();
  }

  // === Bindings
  $("numPlayers").addEventListener("change",renderPlayersConfigurator);
  $("shuffle").addEventListener("click",()=>{
    const n = parseInt($("numPlayers").value,10);
    const pool = ["Ella","Pareja","Bull","Amiga","Amigo","Invitado","X1","X2","X3"];
    for(let i=0;i<n;i++){ $("pname_"+i).value = pool[(Math.random()*pool.length)|0]; }
    toast("üîÄ Nombres aleatorizados");
  });

  $("start").addEventListener("click",()=>{
    collectPlayers(); if(state.players.length<2){toast("M√≠nimo 2 jugadores");return;}
    state.inGame = true;
    document.getElementById("setup").style.display="none";
    document.getElementById("game").style.display="block";
    listPlayers(); resetGame(); // resetGame ya pone BAJO; si quieres iniciar en otro, cambia aqu√≠:
    // setLevel(state.levelIndex); // si prefieres respetar el nivel elegido antes de iniciar
    toast(`‚úÖ ¬°Partida iniciada! Nivel ${currentLevel()}`);
  });

  $("next").addEventListener("click",nextChallenge);
  $("skip").addEventListener("click",nextChallenge);
  $("reset").addEventListener("click",()=>{ resetGame(); toast("üîÑ Reiniciado"); });
  $("backToSetup").addEventListener("click",()=>{
    document.getElementById("game").style.display="none";
    document.getElementById("setup").style.display="block";
    state.inGame = false;
    syncUI();
    toast("‚Ü©Ô∏è Inicio");
  });

  // Cambios de nivel manuales (‚óÄÔ∏é/‚ñ∂Ô∏é)
  $("incLvl").addEventListener("click",()=> setLevel(state.levelIndex+1, {manual:true}));
  $("decLvl").addEventListener("click",()=> setLevel(state.levelIndex-1, {manual:true}));

  // init
  renderPlayersConfigurator();
  syncUI(); // asegura texto bot√≥n y chips
});
</script>
</body>
</html>
